<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT Pro Dashboard</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Bootstrap 5 & FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/locales/it.global.min.js'></script>

    <style>
        :root {
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --accent-primary: #4f46e5; /* Indaco */
            
            /* Colori Eventi */
            --color-lesson: #4338ca; /* Blu scuro */
            --bg-lesson: #e0e7ff;
            
            --color-shift: #059669; /* Verde */
            --bg-shift: #d1fae5;
            
            --color-task: #d97706; /* Arancio */
            --bg-task: #fef3c7;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            overflow: hidden; /* Evita scroll doppio */
            height: 100vh;
            margin: 0;
        }

        /* LAYOUT */
        .wrapper {
            display: flex;
            height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: 280px;
            background: var(--bg-card);
            padding: 25px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e5e7eb;
            box-shadow: 4px 0 24px rgba(0,0,0,0.02);
            z-index: 10;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-primary);
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-add-big {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-weight: 600;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        .btn-add-big:hover { background: #4338ca; transform: translateY(-2px); color: white;}

        .filter-section {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
        }
        
        .filter-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-weight: 700;
        }

        /* Toggle Switch Custom */
        .filter-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            cursor: pointer;
        }
        .filter-label { font-size: 0.95rem; font-weight: 500; display: flex; align-items: center; gap: 8px;}
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block;}
        .dot-lesson { background: var(--color-lesson); }
        .dot-shift { background: var(--color-shift); }
        .dot-task { background: var(--color-task); }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        #calendar-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            height: 100%;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* FULLCALENDAR CUSTOMIZATION */
        /* FULLCALENDAR CUSTOMIZATION - STILE APPLE */
        .fc { border: none !important; font-family: 'Inter', sans-serif; }
        
        /* HEADER & GRIGLIA */
        .fc-theme-standard td, .fc-theme-standard th { border-color: #f1f1f1; }
        .fc-timegrid-slot { height: 50px !important; border-bottom: 1px solid #f8f9fa; } /* Righe più alte */
        .fc-col-header-cell { background: #fff; padding: 15px 0; border-bottom: 1px solid #eee; }
        .fc-col-header-cell-cushion { color: #111; font-weight: 800; text-transform: uppercase; text-decoration: none !important; font-size: 0.85rem; }
        .fc-timegrid-axis-cushion { color: #999; font-size: 0.75rem; }
        
        /* PULSANTI TOOLBAR */
        .fc-header-toolbar { margin-bottom: 1.5rem !important; }
        .fc-toolbar-title { font-size: 1.5rem !important; font-weight: 800; color: #111; }
        .fc-button-primary { 
            background-color: transparent !important; 
            color: #111 !important; 
            border: 1px solid #e5e7eb !important;
            font-weight: 600;
            border-radius: 8px !important;
            box-shadow: none !important;
            padding: 6px 12px !important;
        }
        .fc-button-active { background-color: #111 !important; color: white !important; border-color: #111 !important; }
        .fc-button-primary:hover { background-color: #f3f4f6 !important; }

        /* EVENTI (Design a pillola pulita) */
        .fc-event {
            border: none !important;
            border-radius: 6px !important;
            padding: 2px 5px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.04);
            transition: transform 0.1s;
        }
        .fc-event:hover { transform: scale(1.02); z-index: 50; }

        /* Colori Eventi ridefiniti per stile Apple */
        /* --- COLORI EVENTI STILE APPLE (Testo Scuro su Sfondo Chiaro) --- */
        
        /* Regola generale evento */
        .fc-event {
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-weight: 700 !important; /* Testo bello grassetto */
            border: none !important;
            border-radius: 6px !important;
        }
        
        /* LEZIONE (Blu) */
        .evt-lesson {
            background-color: #e0e7ff !important; /* Sfondo Blu Chiaro */
            border-left: 4px solid #4338ca !important; /* Bordo Blu Scuro */
        }
        /* Forza il testo BLU SCURO ovunque dentro l'evento */
        .evt-lesson, .evt-lesson div, .evt-lesson span {
            color: #1e1b4b !important; 
        }

        /* TURNO (Verde) */
        .evt-shift {
            background-color: #d1fae5 !important; /* Sfondo Verde Chiaro */
            border-left: 4px solid #059669 !important; /* Bordo Verde Scuro */
        }
        /* Forza il testo VERDE SCURO ovunque dentro l'evento */
        .evt-shift, .evt-shift div, .evt-shift span {
            color: #064e3b !important; 
        }

        /* TASK (Arancione) */
        .evt-task {
            background-color: #fef3c7 !important; /* Sfondo Giallo Chiaro */
            border-left: 4px solid #d97706 !important; /* Bordo Arancio */
        }
        /* Forza il testo MARRONE SCURO ovunque dentro l'evento */
        .evt-task, .evt-task div, .evt-task span {
            color: #78350f !important;
        }

        /* AGENDA / LIST VIEW (La trasformazione vera) */
        .fc-list { border: none !important; }
        .fc-list-day-cushion { background-color: #fafafa !important; padding: 15px !important; }
        .fc-list-day-text { font-size: 1.1rem; font-weight: 800; color: #000; text-transform: capitalize; }
        .fc-list-day-side-text { font-size: 1rem; color: #888; font-weight: 400; }
        
        .fc-list-event td { border: none !important; padding: 12px 15px !important; background: #fff; border-bottom: 1px solid #f3f4f6 !important; }
        .fc-list-event:hover td { background: #f8fafc !important; cursor: pointer; }
        
        .fc-list-event-graphic { display: none; } /* Nascondiamo il pallino standard */
        .fc-list-event-time { width: 70px; font-weight: 600; color: #6b7280; font-size: 0.9rem; }
        .fc-list-event-title { font-weight: 600; font-size: 1rem; color: #1f2937; display: flex; align-items: center; gap: 10px; }
        
        /* Pallino colorato custom nell'agenda */
        .fc-list-event-title::before { content: ''; width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .evt-lesson .fc-list-event-title::before { background: #4f46e5; }
        .evt-shift .fc-list-event-title::before { background: #10b981; }
        .evt-task .fc-list-event-title::before { background: #f59e0b; }

        /* MODALE */
        .modal-content { border-radius: 16px; border: none; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal-header { border-bottom: 1px solid #f3f4f6; padding: 20px 25px; }
        .modal-body { padding: 25px; background: #fdfdfd; }
        .modal-footer { border-top: 1px solid #f3f4f6; padding: 15px 25px; }
        
        /* Radio Buttons Event Type */
        .type-selector {
            display: flex; gap: 10px; margin-bottom: 20px;
        }
        .type-option {
            flex: 1;
            text-align: center;
        }
        .type-option input { display: none; }
        .type-option label {
            display: block;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .type-option input:checked + label {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            background: #eef2ff;
        }

        /* LOADER */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }


        /* --- RESPONSIVE STYLES (MOBILE) --- */
        
        /* Bottone Menu Mobile (inizialmente nascosto su desktop) */
        .mobile-menu-btn {
            display: none; 
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--accent-primary);
            color: white;
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 100;
            font-size: 1.5rem;
            align-items: center;
            justify-content: center;
        }

        /* Overlay scuro per quando il menu è aperto */
        #sidebar-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9;
            backdrop-filter: blur(2px);
        }

        @media (max-width: 991px) {
            /* 1. Mostra il bottone menu */
            .mobile-menu-btn { display: flex; }

            /* 2. Trasforma la Sidebar in un "Drawer" laterale */
            .sidebar {
                position: fixed;
                left: -100%; /* Nascondi fuori schermo */
                top: 0;
                height: 100vh;
                width: 85%; /* Occupa quasi tutto lo schermo */
                max-width: 320px;
                transition: left 0.3s ease-in-out;
            }
            
            /* Classe per aprire la sidebar */
            .sidebar.active { left: 0; }
            
            /* Mostra overlay quando attivo */
            .sidebar.active ~ #sidebar-overlay { display: block; }

            /* 3. Main content a tutto schermo */
            .main-content {
                width: 100%;
                padding: 10px; /* Meno padding su mobile */
            }

            /* 4. Adattamenti FullCalendar */
            .fc-header-toolbar {
                flex-direction: column;
                gap: 10px;
            }
            .fc-toolbar-title {
                font-size: 1.2rem !important;
            }
            .fc .fc-button {
                padding: 4px 8px;
                font-size: 0.85rem;
            }
            /* Nascondi pulsanti mese/settimana troppo ingombranti su mobile molto piccoli */
            .fc-right {
                width: 100%;
                display: flex;
                justify-content: center;
            }
        }
        /* --- MOBILE RESPONSIVE --- */
        #mobile-menu-btn { display: none; }
        #sidebar-overlay { display: none; }

        @media (max-width: 991px) {
            /* Struttura */
            .wrapper { position: relative; overflow-x: hidden; }
            .sidebar {
                position: fixed; left: -100%; top: 0; height: 100vh; width: 85%; max-width: 300px;
                z-index: 1050; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .sidebar.active { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.1); }
            
            /* Overlay scuro */
            #sidebar-overlay {
                display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
                background: rgba(0,0,0,0.4); z-index: 1040; backdrop-filter: blur(2px);
            }
            .sidebar.active ~ #sidebar-overlay { display: block; }

            /* Bottone Menu */
            #mobile-menu-btn {
                display: flex; align-items: center; justify-content: center;
                position: fixed; bottom: 25px; right: 25px;
                width: 56px; height: 56px; border-radius: 50%;
                background: var(--accent-primary); color: white;
                border: none; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
                font-size: 1.5rem; z-index: 1030;
            }

            /* Fix Calendario Mobile */
            .main-content { padding: 10px; width: 100%; }
            #calendar-card { padding: 10px; border-radius: 0; box-shadow: none; }
            
            .fc-header-toolbar { flex-direction: column; gap: 10px; align-items: stretch !important; }
            .fc-toolbar-chunk { display: flex; justify-content: space-between; align-items: center; }
            .fc-toolbar-title { font-size: 1.25rem !important; }
            
            /* Nascondi pulsanti inutili su mobile */
            
        }
    </style>
</head>
<body>
<body>
    <!-- NUOVO: Overlay per chiudere il menu cliccando fuori -->
    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- NUOVO: Bottone galleggiante per Mobile -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </button>

    <div class="wrapper">
        <!-- SIDEBAR -->
        <nav class="sidebar">
            <div class="brand">
                <i class="bi bi-activity"></i> PT Manager
            </div>

            <button class="btn-add-big" onclick="openModal()">
                <i class="bi bi-plus-lg"></i> Nuovo Evento
            </button>

            <div class="filter-section">
                <div class="filter-title">Filtra Visualizzazione</div>
                
                <div class="filter-row">
                    <div class="filter-label"><span class="dot dot-lesson"></span> Lezioni Clienti</div>
                    <div class="form-check form-switch">
                        <input class="form-check-input filter-check" type="checkbox" value="lesson" checked onchange="refreshCalendarFilters()">
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-label"><span class="dot dot-shift"></span> Miei Turni</div>
                    <div class="form-check form-switch">
                        <input class="form-check-input filter-check" type="checkbox" value="shift" checked onchange="refreshCalendarFilters()">
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-label"><span class="dot dot-task"></span> Task / Note</div>
                    <div class="form-check form-switch">
                        <input class="form-check-input filter-check" type="checkbox" value="task" checked onchange="refreshCalendarFilters()">
                    </div>
                </div>
            </div>

            <div class="mt-auto text-muted small">
                <i class="bi bi-cloud-check"></i> Firebase Connected
            </div>
        </nav>

        <!-- MAIN CALENDAR AREA -->
        <main class="main-content">
            <div id="calendar-card">
                <div id="calendar"></div>
            </div>
        </main>
    </div>

    <!-- MODAL -->
    <div class="modal fade" id="eventModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="modalTitle">Gestisci Appuntamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="eventForm">
                        <input type="hidden" id="eventId">

                        <!-- Tipo -->
                        <div class="type-selector">
                            <div class="type-option">
                                <input type="radio" name="eventType" id="t_lesson" value="lesson" checked onclick="toggleFields()">
                                <label for="t_lesson"><i class="bi bi-people-fill"></i> Lezione</label>
                            </div>
                            <div class="type-option">
                                <input type="radio" name="eventType" id="t_shift" value="shift" onclick="toggleFields()">
                                <label for="t_shift"><i class="bi bi-clock-history"></i> Turno</label>
                            </div>
                            <div class="type-option">
                                <input type="radio" name="eventType" id="t_task" value="task" onclick="toggleFields()">
                                <label for="t_task"><i class="bi bi-list-check"></i> Task</label>
                            </div>
                        </div>

                        <!-- Orari -->
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label small text-muted text-uppercase fw-bold">Inizio</label>
                                <input type="datetime-local" class="form-control" id="startInput">
                            </div>
                            <div class="col-6">
                                <label class="form-label small text-muted text-uppercase fw-bold">Fine</label>
                                <input type="datetime-local" class="form-control" id="endInput">
                            </div>
                        </div>

                        <!-- Campi Lezione -->
                        <div id="lessonFields">
                            <div class="mb-3">
                                <label class="form-label">Cliente</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light"><i class="bi bi-person"></i></span>
                                    <input type="text" class="form-control" id="clientName" placeholder="Nome e Cognome">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Allegato (PDF/IMG)</label>
                                <input type="file" class="form-control" id="fileInput">
                                <div class="mt-2" id="currentFileLink"></div>
                            </div>
                        </div>

                        <!-- Campi Task / Note Generiche -->
                        <div id="genericFields">
                             <div class="mb-3">
                                <label class="form-label">Note / Descrizione</label>
                                <textarea class="form-control" id="notes" rows="3" placeholder="Scrivi qui i dettagli..."></textarea>
                            </div>
                        </div>

                    </form>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-outline-danger me-auto border-0" id="btnDelete" onclick="deleteCurrentEvent()" style="display:none;">
                        <i class="bi bi-trash"></i> Elimina
                    </button>
                    <button type="button" class="btn btn-dark px-4" onclick="saveEvent()">Salva Modifiche</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOADER -->
    <div id="loader">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
        <p class="mt-2 text-muted fw-bold">Caricamento Agenda...</p>
    </div>

    <!-- Logic -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // Importiamo SOLO Firestore (il database), niente Storage
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // TUA CONFIGURAZIONE (Rimane uguale)
        const firebaseConfig = {
            apiKey: "AIzaSyDuYQqNPgdQ6e5sO7hzMnrrmzg7cBmHusA",
            authDomain: "calendario-79a93.firebaseapp.com",
            projectId: "calendario-79a93",
            storageBucket: "calendario-79a93.appspot.com",
            messagingSenderId: "981317951328",
            appId: "1:981317951328:web:38b9b95bfe654b4904c805",
            measurementId: "G-08GZ6DPFWK"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Niente variabile 'storage' qui!

        let calendar;
        let allEvents = []; 
        const modalElement = new bootstrap.Modal(document.getElementById('eventModal'));

        // --- INIZIALIZZA APP ---
        document.addEventListener('DOMContentLoaded', function() {
            initCalendar();
            loadEvents();
        });

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            // Rileva se larghezza schermo è inferiore a 991px (Tablet/Mobile)
            const isMobile = window.innerWidth < 991; 

            calendar = new FullCalendar.Calendar(calendarEl, {
                // Se Mobile -> Vista 3 Giorni, Altrimenti -> Settimana
                initialView: isMobile ? 'mobileThreeDay' : 'timeGridWeek',
                locale: 'it', 
                firstDay: 1, 
                
                // DEFINIZIONE VISTA "3 GIORNI"
                views: {
                    mobileThreeDay: {
                        type: 'timeGrid',
                        duration: { days: 3 }, // Mostra 3 giorni
                        buttonText: '3 gg'     // Testo del bottone
                    }
                },

                headerToolbar: {
                    left: 'prev,next', // Frecce navigazione
                    center: 'title',
                    // MOBILE: Solo "Mese" e "3 gg"
                    // DESKTOP: "Mese", "Settimana", "Agenda"
                    right: isMobile ? 'dayGridMonth,mobileThreeDay' : 'dayGridMonth,timeGridWeek,listWeek'
                },
                
                // FORMATTAZIONE (Stile pulito)
                // Es Mobile: "Lun 9" | Es Desktop: "Lunedì 9"
                dayHeaderFormat: { weekday: isMobile ? 'short' : 'long', day: 'numeric', omitCommas: true }, 
                slotLabelFormat: { hour: 'numeric', minute: '2-digit', omitZeroMinute: false, hour12: false },
                
                slotMinTime: "06:00:00",
                slotMaxTime: "23:00:00",
                allDaySlot: false,
                height: '100%',
                expandRows: true,
                slotEventOverlap: false, 
                nowIndicator: true,
                
                dateClick: (info) => { openModalNew(info.date); },
                eventClick: (info) => { openModalEdit(info.event); },
                
                // Render dell'evento grafico
                eventContent: function(arg) {
                    let icon = '';
                    // Icone semplici
                    if(arg.event.extendedProps.type === 'lesson') icon = '<i class="bi bi-person-fill"></i>';
                    else if(arg.event.extendedProps.type === 'task') icon = '<i class="bi bi-pin-fill"></i>';
                    // Nota: Per i turni niente icona per lasciare spazio al testo
                    
                    return { html: `<div class="d-flex gap-1 align-items-center text-truncate" style="line-height:1.2; font-weight:700;">${icon} <span>${arg.event.title}</span></div>` }
                }
            });
            calendar.render();
        }
        
        
        
        
        window.addEventListener('resize', () => {
            if(calendar) {
                const newView = window.innerWidth < 768 ? 'timeGridDay' : 'timeGridWeek';
                if(calendar.view.type !== newView) {
                    calendar.changeView(newView);
                }
            }
        });

        // --- FIREBASE LOGIC ---
        async function loadEvents() {
            showLoader(true);
            try {
                const q = await getDocs(collection(db, "events"));
                allEvents = []; 
                q.forEach(doc => {
                    const data = doc.data();
                    let title = data.title;
                    let className = 'evt-task';
                    
                    if(data.type === 'lesson') {
                        title = data.clientName;
                        className = 'evt-lesson';
                    } else if (data.type === 'shift') {
                        title = "Turno"; 
                        className = 'evt-shift';
                    }

                    allEvents.push({
                        id: doc.id,
                        title: title || "Evento",
                        start: data.start,
                        end: data.end,
                        classNames: [className],
                        extendedProps: { ...data } 
                    });
                });
                refreshCalendarFilters(); 
            } catch (e) {
                console.error(e);
                alert("Errore caricamento dati: " + e.message);
            }
            showLoader(false);
        }

        window.refreshCalendarFilters = function() {
            const activeTypes = [];
            document.querySelectorAll('.filter-check:checked').forEach(cb => activeTypes.push(cb.value));
            const filtered = allEvents.filter(ev => activeTypes.includes(ev.extendedProps.type));
            calendar.removeAllEvents();
            calendar.addEventSource(filtered);
        }

        // --- SALVATAGGIO CON FILE BASE64 (Senza Storage esterno) ---
        window.saveEvent = async function() {
            const id = document.getElementById('eventId').value;
            const type = document.querySelector('input[name="eventType"]:checked').value;
            const start = document.getElementById('startInput').value;
            const end = document.getElementById('endInput').value;
            const clientName = document.getElementById('clientName').value;
            const notes = document.getElementById('notes').value;
            const fileInput = document.getElementById('fileInput');

            if(!start || !end) return alert("Inserisci orari");

            if(type === 'lesson') {
                if(checkOverlap(start, end, id)) {
                    if(!confirm("⚠️ Attenzione: Sovrapposizione rilevata! Continuare?")) return;
                }
            }

            // Funzione interna per salvare i dati
            const saveDataToDb = async (fileData, fileName) => {
                showLoader(true);
                const data = {
                    type, start, end, 
                    clientName: type === 'lesson' ? clientName : "",
                    notes,
                    title: type === 'task' ? notes.substring(0, 20) : (type === 'lesson' ? clientName : "Turno"),
                    // Se c'è un nuovo file uso quello, altrimenti tengo quello vecchio (o stringa vuota)
                    fileUrl: fileData || (document.getElementById('currentFileLink').dataset.url || ""),
                    fileName: fileName || (document.getElementById('currentFileLink').dataset.name || "")
                };

                try {
                    if(id) await updateDoc(doc(db, "events", id), data);
                    else await addDoc(collection(db, "events"), data);
                    
                    modalElement.hide();
                    loadEvents();
                } catch(e) { 
                    console.error(e); 
                    alert("Errore salvataggio: " + e.message); 
                } finally {
                    showLoader(false);
                }
            };

            // Gestione File
            if(fileInput.files[0]) {
                const f = fileInput.files[0];
                
                // CONTROLLO DIMENSIONE (Limite 800KB circa per stare sicuri nel DB)
                if (f.size > 800 * 1024) {
                    alert("⚠️ Il file è troppo grande! Per questo metodo 'senza costi', carica file sotto gli 800KB (quasi 1MB).");
                    return;
                }

                // Converti file in testo (Base64)
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64String = e.target.result;
                    saveDataToDb(base64String, f.name);
                };
                reader.readAsDataURL(f); // Avvia lettura
            } else {
                // Nessun file nuovo caricato, salva direttamente
                saveDataToDb(null, null);
            }
        }

        window.deleteCurrentEvent = async function() {
            const id = document.getElementById('eventId').value;
            if(!id) return;
            if(confirm("Eliminare definitivamente?")) {
                showLoader(true);
                await deleteDoc(doc(db, "events", id));
                modalElement.hide();
                loadEvents();
                showLoader(false);
            }
        }

        function checkOverlap(start, end, excludeId) {
            const nStart = new Date(start).getTime();
            const nEnd = new Date(end).getTime();
            const lessons = allEvents.filter(e => e.extendedProps.type === 'lesson' && e.id !== excludeId);
            return lessons.some(ev => {
                const eStart = new Date(ev.start).getTime();
                const eEnd = new Date(ev.end).getTime();
                return (nStart < eEnd && nEnd > eStart);
            });
        }

        window.openModal = function() { openModalNew(new Date()); }
        
        function openModalNew(dateObj) {
            resetForm();
            let d = new Date(dateObj);
            if (dateObj.getHours() === 0 && dateObj.getMinutes() === 0) {
                 d = new Date(); d.setMinutes(0,0,0);
            }
            document.getElementById('startInput').value = toIso(d);
            document.getElementById('endInput').value = toIso(new Date(d.getTime() + 3600000));
            modalElement.show();
        }

        function openModalEdit(event) {
            resetForm();
            const p = event.extendedProps;
            document.getElementById('eventId').value = event.id;
            document.getElementById('startInput').value = toIso(new Date(event.start));
            document.getElementById('endInput').value = toIso(new Date(event.end));
            document.getElementById('btnDelete').style.display = 'inline-block';
            
            document.querySelector(`input[name="eventType"][value="${p.type}"]`).checked = true;
            document.getElementById('clientName').value = p.clientName || "";
            document.getElementById('notes').value = p.notes || "";
            
            if(p.fileUrl) {
                const div = document.getElementById('currentFileLink');
                // Nota: download="${p.fileName}" forza il browser a scaricare il file invece di aprirlo
                div.innerHTML = `<a href="${p.fileUrl}" download="${p.fileName}" class="badge bg-primary text-decoration-none p-2"><i class="bi bi-download"></i> Scarica: ${p.fileName || 'File'}</a>`;
                div.dataset.url = p.fileUrl;
                div.dataset.name = p.fileName;
            }
            toggleFields();
            modalElement.show();
        }

        window.toggleFields = function() {
            const type = document.querySelector('input[name="eventType"]:checked').value;
            const lessonDiv = document.getElementById('lessonFields');
            const genericDiv = document.getElementById('genericFields'); 
            
            if(type === 'lesson') {
                lessonDiv.style.display = 'block';
                genericDiv.style.display = 'block';
            } else if (type === 'task') {
                lessonDiv.style.display = 'none';
                genericDiv.style.display = 'block';
            } else { 
                lessonDiv.style.display = 'none';
                genericDiv.style.display = 'none'; 
            }
        }

        function resetForm() {
            document.getElementById('eventForm').reset();
            document.getElementById('eventId').value = "";
            document.getElementById('currentFileLink').innerHTML = "";
            document.getElementById('currentFileLink').dataset.url = "";
            document.getElementById('currentFileLink').dataset.name = "";
            document.getElementById('btnDelete').style.display = 'none';
            document.getElementById('t_lesson').checked = true;
            toggleFields();
        }

        function toIso(date) {
            const pad = n => n<10 ? '0'+n : n;
            return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
        window.toggleSidebar = function() {
            document.querySelector('.sidebar').classList.toggle('active');
        }
    </script>
</body>
</html>